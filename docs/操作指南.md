# 医学指标计算系统操作指南

## 📋 系统概述

医学指标计算系统是一个基于大语言模型（LLM）的自动化医学指标计算和评估系统。该系统能够从电子病历中自动提取相关信息，并计算各种医学质控指标。

## 🚀 快速开始

### 1. 环境准备

#### 安装依赖
```bash
pip install -r requirements.txt
```

#### 目录结构
```
text2rule/
├── config/                 # 配置文件
│   ├── __init__.py
│   └── settings.py
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── utils.py
│   ├── llm_client.py
│   ├── data_loader.py
│   └── function_executor.py
├── executor/               # 执行器模块
│   ├── __init__.py
│   └── main_executor.py
├── web/                    # Web界面
│   ├── __init__.py
│   └── gradio_app.py
├── data/                   # 数据目录
│   ├── generated_functions/
│   ├── patient_data/
│   └── ...
├── results/                # 结果目录
│   └── execution_results/
├── logs/                   # 日志目录
├── main.py                 # 主程序入口
└── requirements.txt
```

### 2. 运行方式

#### Web界面模式（推荐）
```bash
python main.py --mode web
```
然后在浏览器中访问 `http://localhost:7860`

#### 命令行模式
```bash
python main.py --mode cli --api-key YOUR_API_KEY --base-url YOUR_BASE_URL --task-type cmqcic
```

## 🔧 配置说明

### API配置

系统支持两种LLM提供商：

#### OpenAI配置
```python
OPENAI_CONFIG = {
    "key": "your-openai-api-key",
    "base_url": "https://api.openai.com/v1",
    "extraction_model": "gpt-4o-mini-2024-07-18",
    "conversion_model": "gpt-4o-mini-2024-07-18"
}
```

#### Qwen配置
```python
QWEN_CONFIG = {
    "key": "your-qwen-api-key",
    "base_url": "your-qwen-base-url",
    "extraction_model": "qwen2.5-72b-instruct",
    "conversion_model": "qwen2.5-72b-instruct"
}
```

### 任务配置

系统支持两种任务类型：

#### CMCIC任务
- 文件：`data/data.jsonl`
- ID字段：`unique_id`
- 病历字段：`patient note`

#### MedCalc任务
- 文件：`data/MedCalc_test_data.jsonl`
- ID字段：`Calculator ID`
- 病历字段：`Patient Note`

## 📊 使用流程

### 1. Web界面使用

#### 系统配置
1. 打开Web界面
2. 在"系统配置"标签页中输入API配置
3. 选择模型提供商（OpenAI或Qwen）
4. 点击"测试连接"验证配置
5. 选择任务类型并加载任务列表

#### 任务执行
1. 切换到"任务执行"标签页
2. 点击"开始执行"进行批量处理
3. 查看执行进度和状态

#### 单任务测试
1. 切换到"单任务测试"标签页
2. 选择要测试的任务
3. 输入患者病历内容
4. 点击"测试任务"查看结果

#### 结果查看
1. 切换到"结果查看"标签页
2. 选择结果文件
3. 点击"加载结果"查看数据

### 2. 命令行使用

#### 基本用法
```bash
python main.py --mode cli \
    --api-key YOUR_API_KEY \
    --base-url YOUR_BASE_URL \
    --provider openai \
    --task-type cmqcic
```

#### 高级用法
```bash
python main.py --mode cli \
    --api-key YOUR_API_KEY \
    --base-url YOUR_BASE_URL \
    --provider qwen \
    --task-type medcalc \
    --include-ids task1 task2 task3 \
    --output-file results/custom_results.jsonl
```

## 📁 数据格式

### 生成函数文件格式
```json
{
    "task_index": "任务ID",
    "python_code": "def calculate_indicator(...): ...",
    "properties": {
        "row": "{\"property1\": \"type1\", \"property2\": \"type2\"}"
    },
    "need_unit": {
        "property1": "unit1",
        "property2": "unit2"
    }
}
```

### 患者数据文件格式
```json
{
    "unique_id": "患者ID",
    "patient note": "患者病历内容..."
}
```

### 结果文件格式
```json
{
    "id": "任务ID",
    "results": [
        {
            "extract_para": {"param1": "value1"},
            "result": 0.85
        }
    ]
}
```

## 🔍 故障排除

### 常见问题

#### 1. API连接失败
- 检查API Key是否正确
- 检查Base URL是否可访问
- 确认网络连接正常

#### 2. 任务执行失败
- 检查数据文件是否存在
- 确认文件格式正确
- 查看日志文件获取详细错误信息

#### 3. 内存不足
- 减少并发任务数量
- 分批处理大量数据
- 增加系统内存

### 日志查看
日志文件位于 `logs/` 目录下，包含详细的执行信息和错误信息。

## 🛠️ 开发指南

### 添加新的LLM提供商
1. 在 `config/settings.py` 中添加新的配置
2. 在 `core/llm_client.py` 中实现相应的客户端
3. 更新Web界面中的提供商选项

### 添加新的任务类型
1. 在 `config/settings.py` 中添加任务配置
2. 准备相应的数据文件
3. 更新Web界面中的任务类型选项

### 自定义提示词
在 `config/settings.py` 的 `PromptConfig` 类中修改相应的提示词。

## 📞 技术支持

如遇到问题，请：
1. 查看日志文件获取详细错误信息
2. 检查配置文件是否正确
3. 确认数据文件格式是否符合要求
4. 联系技术支持团队

## 📄 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。 